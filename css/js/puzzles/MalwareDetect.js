/**
 * MalwareDetect - Malware detection puzzle
 * Players identify infected files in a system scan
 */

import { CONFIG } from '../data/config.js';
import { AudioManager } from '../core/AudioManager.js';

export class MalwareDetect {
    constructor(puzzleData, gameScreen) {
        this.gameScreen = gameScreen;
        this.audio = AudioManager.getInstance();
        
        // Puzzle configuration
        this.totalFiles = puzzleData.totalFiles || 15;
        this.infectedCount = puzzleData.infectedFiles || 4;
        this.timeLimit = puzzleData.timeLimit || 180; // 3 minutes
        
        // Generate files
        this.files = this.generateFiles();
        
        // State
        this.selectedFiles = new Set();
        this.scannedFiles = new Set();
        this.isComplete = false;
        this.falsePositives = 0;
        
        console.log('ü¶† Malware detection puzzle initialized:', this.totalFiles, 'files');
    }

    /**
     * Generate file list with some infected
     * @returns {Array} File objects
     */
    generateFiles() {
        const fileNames = [
            'system32.dll', 'config.ini', 'update.exe', 'readme.txt',
            'installer.msi', 'backup.zip', 'driver.sys', 'document.pdf',
            'image.jpg', 'video.mp4', 'audio.mp3', 'script.js',
            'database.db', 'log.txt', 'cache.tmp', 'temp.dat',
            'service.exe', 'plugin.dll', 'library.so', 'archive.rar'
        ];

        const files = [];
        const usedNames = new Set();

        // Generate unique files
        for (let i = 0; i < this.totalFiles; i++) {
            let name;
            do {
                name = fileNames[Math.floor(Math.random() * fileNames.length)];
            } while (usedNames.has(name));
            usedNames.add(name);

            const size = Math.floor(Math.random() * 10000) + 100; // 100-10100 KB
            const hash = this.generateHash();
            
            files.push({
                id: i,
                name: name,
                size: size,
                hash: hash,
                infected: false,
                suspicionLevel: 0
            });
        }

        // Mark some as infected
        const infected = new Set();
        while (infected.size < this.infectedCount) {
            const id = Math.floor(Math.random() * this.totalFiles);
            infected.add(id);
        }

        infected.forEach(id => {
            files[id].infected = true;
            files[id].suspicionLevel = Math.random() * 50 + 50; // 50-100%
            
            // Add suspicious indicators
            if (Math.random() > 0.5) {
                files[id].size = Math.floor(Math.random() * 5000) + 15000; // Unusually large
            }
            if (Math.random() > 0.5) {
                files[id].hash = 'XX' + files[id].hash.slice(2); // Suspicious hash pattern
            }
        });

        // Add some false flags to safe files
        files.forEach(file => {
            if (!file.infected) {
                file.suspicionLevel = Math.random() * 40; // 0-40%
            }
        });

        return files;
    }

    /**
     * Generate random hash
     * @returns {string} Hash string
     */
    generateHash() {
        const chars = '0123456789ABCDEF';
        let hash = '';
        for (let i = 0; i < 16; i++) {
            hash += chars[Math.floor(Math.random() * chars.length)];
        }
        return hash;
    }

    /**
     * Initialize and render the puzzle
     * @param {HTMLElement} container - Container element
     */
    render(container) {
        container.innerHTML = `
            <div class="malware-puzzle">
                <h2 class="puzzle-title">MALWARE DETECTION PROTOCOL</h2>
                
                <div class="puzzle-instructions">
                    <strong style="color: var(--cyber-blue);">MISSION:</strong>
                    <p style="margin-top: 10px; color: var(--text-secondary);">
                        Scan the file system and identify <span style="color: var(--cyber-pink);">${this.infectedCount} infected files</span>. 
                        Click files to mark as suspicious. Submit your findings when ready.
                    </p>
                </div>

                <div class="malware-stats" style="display: flex; justify-content: space-around; margin-bottom: 20px; padding: 15px; background: var(--darker-bg); border: 1px solid var(--cyber-blue);">
                    <div style="text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Files Scanned</div>
                        <div style="color: var(--cyber-blue); font-size: 1.5rem;" id="malware-scanned">0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Marked Suspicious</div>
                        <div style="color: var(--cyber-pink); font-size: 1.5rem;" id="malware-marked">0</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: var(--text-secondary); font-size: 0.9rem;">Target</div>
                        <div style="color: var(--cyber-green); font-size: 1.5rem;">${this.infectedCount}</div>
                    </div>
                </div>
                
                <div class="file-list" id="file-list">
                    ${this.renderFileList()}
                </div>
                
                <div class="puzzle-actions" style="margin-top: 20px;">
                    <button class="btn btn-primary" id="malware-submit">
                        SUBMIT REPORT
                    </button>
                    <button class="btn" id="malware-scan-all">
                        SCAN ALL FILES
                    </button>
                    <button class="btn" id="malware-clear">
                        CLEAR SELECTION
                    </button>
                </div>
            </div>
        `;

        this.setupEventListeners();
    }

    /**
     * Render file list
     * @returns {string} File list HTML
     */
    renderFileList() {
        return this.files.map(file => {
            const isSelected = this.selectedFiles.has(file.id);
            const isScanned = this.scannedFiles.has(file.id);
            
            return `
                <div class="file-item ${isSelected ? 'selected' : ''}" data-file="${file.id}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div class="file-name">${file.name}</div>
                            <div style="display: flex; gap: 20px; margin-top: 5px;">
                                <span class="file-size" style="color: var(--text-muted); font-size: 0.85rem;">
                                    Size: ${file.size} KB
                                </span>
                                ${isScanned ? `
                                    <span style="color: ${file.suspicionLevel > 50 ? 'var(--cyber-pink)' : 'var(--cyber-green)'}; font-size: 0.85rem;">
                                        Risk: ${Math.floor(file.suspicionLevel)}%
                                    </span>
                                ` : ''}
                            </div>
                            ${isScanned ? `
                                <div class="file-hash" style="margin-top: 3px; font-size: 0.75rem;">
                                    Hash: ${file.hash}
                                </div>
                            ` : ''}
                        </div>
                        <div>
                            ${isSelected ? 
                                '<span style="color: var(--cyber-pink); font-size: 1.5rem;">‚ö†Ô∏è</span>' : 
                                '<span style="color: var(--text-muted); font-size: 1.2rem;">üìÑ</span>'
                            }
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    /**
     * Setup event listeners
     */
    setupEventListeners() {
        const fileList = document.getElementById('file-list');
        if (!fileList) return;

        // File click handler
        fileList.addEventListener('click', (e) => {
            const fileItem = e.target.closest('.file-item');
            if (!fileItem) return;
            
            const fileId = parseInt(fileItem.dataset.file);
            this.toggleFileSelection(fileId);
        });

        // Submit button
        const submitBtn = document.getElementById('malware-submit');
        if (submitBtn) {
            submitBtn.addEventListener('click', () => this.submitReport());
        }

        // Scan all button
        const scanBtn = document.getElementById('malware-scan-all');
        if (scanBtn) {
            scanBtn.addEventListener('click', () => this.scanAllFiles());
        }

        // Clear button
        const clearBtn = document.getElementById('malware-clear');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => this.clearSelection());
        }
    }

    /**
     * Toggle file selection
     * @param {number} fileId - File ID
     */
    toggleFileSelection(fileId) {
        if (this.isComplete) return;

        // Scan the file first if not scanned
        if (!this.scannedFiles.has(fileId)) {
            this.scannedFiles.add(fileId);
            this.audio.playSound('typing');
        }

        // Toggle selection
        if (this.selectedFiles.has(fileId)) {
            this.selectedFiles.delete(fileId);
        } else {
            this.selectedFiles.add(fileId);
            this.audio.playButtonClick();
        }

        this.updateDisplay();
        this.gameScreen.updateAttempts(this.scannedFiles.size);
    }

    /**
     * Scan all files at once
     */
    scanAllFiles() {
        this.files.forEach(file => {
            this.scannedFiles.add(file.id);
        });

        this.audio.playHint();
        this.gameScreen.ui.showNotification('All files scanned', 'info');
        this.updateDisplay();

        // Penalty for using scan all
        this.gameScreen.game.score.subtractPoints(200);
        this.gameScreen.updateScore();
    }

    /**
     * Clear all selections
     */
    clearSelection() {
        this.selectedFiles.clear();
        this.audio.playButtonClick();
        this.updateDisplay();
    }

    /**
     * Update display
     */
    updateDisplay() {
        document.getElementById('file-list').innerHTML = this.renderFileList();
        document.getElementById('malware-scanned').textContent = this.scannedFiles.size;
        document.getElementById('malware-marked').textContent = this.selectedFiles.size;
    }

    /**
     * Submit malware report
     */
    submitReport() {
        if (this.isComplete) return;

        if (this.selectedFiles.size === 0) {
            this.gameScreen.ui.showNotification('Select at least one file!', 'warning');
            return;
        }

        this.isComplete = true;

        // Check results
        let correctCount = 0;
        let falsePositives = 0;
        let missedThreats = 0;

        this.files.forEach(file => {
            if (file.infected && this.selectedFiles.has(file.id)) {
                correctCount++;
            } else if (!file.infected && this.selectedFiles.has(file.id)) {
                falsePositives++;
            } else if (file.infected && !this.selectedFiles.has(file.id)) {
                missedThreats++;
            }
        });

        const accuracy = (correctCount / this.infectedCount) * 100;
        this.falsePositives = falsePositives;

        // Show results
        if (correctCount === this.infectedCount && falsePositives === 0) {
            this.onPerfectSuccess(correctCount, falsePositives, missedThreats);
        } else if (correctCount >= this.infectedCount * 0.7) {
            this.onPartialSuccess(correctCount, falsePositives, missedThreats);
        } else {
            this.onFailure(correctCount, falsePositives, missedThreats);
        }
    }

    /**
     * Handle perfect detection
     */
    onPerfectSuccess(correct, falsePos, missed) {
        this.audio.playSuccess();
        this.gameScreen.ui.flashScreen('rgba(0, 255, 65, 0.2)', 300);
        
        this.gameScreen.ui.showNotification('Perfect detection! All threats identified!', 'success');
        this.gameScreen.game.score.addPoints(1000);

        setTimeout(() => {
            this.gameScreen.completePuzzle(true);
        }, 2000);
    }

    /**
     * Handle partial success
     */
    onPartialSuccess(correct, falsePos, missed) {
        this.audio.playSuccess();
        this.gameScreen.ui.flashScreen('rgba(0, 243, 255, 0.2)', 300);
        
        let message = `${correct}/${this.infectedCount} threats found`;
        if (falsePos > 0) message += `, ${falsePos} false positives`;
        if (missed > 0) message += `, ${missed} missed`;
        
        this.gameScreen.ui.showNotification(message, 'success');
        
        // Score penalty for mistakes
        const penalty = (falsePos * 100) + (missed * 150);
        this.gameScreen.game.score.subtractPoints(penalty);

        setTimeout(() => {
            this.gameScreen.completePuzzle(true);
        }, 2000);
    }

    /**
     * Handle failure
     */
    onFailure(correct, falsePos, missed) {
        this.audio.playFailure();
        this.gameScreen.ui.flashScreen('rgba(255, 0, 110, 0.2)', 300);
        
        this.gameScreen.ui.showNotification(
            `Only ${correct}/${this.infectedCount} threats detected. Too many errors!`,
            'error'
        );

        setTimeout(() => {
            this.gameScreen.completePuzzle(false);
        }, 2000);
    }

    /**
     * Get puzzle statistics
     * @returns {Object} Puzzle stats
     */
    getStats() {
        return {
            filesScanned: this.scannedFiles.size,
            filesMarked: this.selectedFiles.size,
            targetCount: this.infectedCount,
            completed: this.isComplete
        };
    }

    /**
     * Clean up puzzle
     */
    destroy() {
        // Remove event listeners
        const fileList = document.getElementById('file-list');
        if (fileList) {
            fileList.replaceWith(fileList.cloneNode(false));
        }
    }
}